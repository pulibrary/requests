<% if @user.guest && @patron.blank? %>
  <%= simple_form_for(:request, { url: "/requests/#{@request.requestable.first.bib['id']}", method: :post, html: { id: 'access_form'} } ) do |l| %>
    <%= render partial: 'user_login_options', locals: { l: l } %>
  <% end %>
<% else %>
<%= simple_form_for(:request, { url: '/requests/submit', method: :post, remote: true} ) do |f| %>
  <%= hidden_fields_request @request %>

    <%= f.hidden_field :user_name, value: "#{pul_patron_name @patron}" %>
    <%= f.hidden_field :user_last_name, value: "#{pul_patron_last_name @patron}" %>
    <%= f.hidden_field :user_barcode, value: @patron[:barcode] %>
    <%= f.hidden_field :patron_id, value: @patron[:patron_id] %>
    <%= f.hidden_field :patron_group, value: @patron[:patron_group] %>
    <%= f.hidden_field :email, value: format_email(@patron[:active_email]) %>

    <% unless @request.source.nil? %>
      <%= f.hidden_field :source, value: @request.source %>
    <% end %>
    <% if @mode == 'trace' %>
      <%= render partial: 'trace_instructions' %>
    <% end %>

    <div>
      <span class="error error-items">
      </span>
    </div>
    <%= render partial: 'umlaut_services' %>
    <% @request.sorted_requestable.each do |mfhd, requestable_list| %>
      <%= hidden_fields_mfhd @request.holdings[mfhd] %>
      <div id="holding<%= mfhd %>" class="table-responsive items">
        <h2><%= @request.holdings[mfhd]["location"] %> <%= @request.holdings[mfhd]["call_number"] %></h2>
          <% unless @request.holdings[mfhd]["location_has"].nil? %>
              <div>
                <h3>Location has: </h3>
              </div>
              <p>
                <% @request.holdings[mfhd]["location_has"].each do |loc| %>
                  <%= loc %><br/>
                <% end %>
              </p>
          <% end %>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-bordered request--available_items <%= show_tablesorter requestable_list%>">
          <thead>
            <th>Select</th>
            <th>Enumeration</th>
            <th>Status</th>
            <th>Delivery Options</th>
          </thead>
          <tbody>
            <% requestable_list.each do |requestable| %>
              <tr id='<%= "request_#{requestable.preferred_request_id}" %>'>
                  <td class='request--select'>
                    <% if requestable.has_item_data? %>
                      <%= hidden_field_tag 'requestable[][selected]', false %>
                      <%= item_checkbox @request.requestable, requestable %>
                      <%= hidden_fields_item requestable %>
                    <% end %>
                  </td>
                  <td>
                    <% if requestable.has_item_data? %>
                      <%= enum_copy_display requestable.item %>
                    <% end %>
                  </td>
                  <td>
                    <% if requestable.has_item_data? %>
                      <%= requestable.item["status"] %><br/>
                      <%= status_label requestable %>
                    <% end %>
                  </td>
                <td class='request--options'>
                  <% if requestable.ill_eligible? %>
                    <span class="ill-data" data-ill-url="<%= requestable.illiad_request_url(@request.ctx, requestable) %>"></span>
                  <% end %>
                  <% if requestable.services.include?('recap_edd') %>
                      <%= hidden_field_tag "requestable[][type]", "recap" %>
                      <%= radio_button_tag "requestable[][delivery_mode_#{requestable.item[:id]}]", "print", false, data: { target: "#fields-print__#{requestable.item['id']}" }, 'aria-expanded' => 'true', 'aria-controls' => "fields-print__#{requestable.item['id']}", class: 'control-label' %>
                      <%= label_tag "requestable__type_recap_#{requestable.item[:id]}", "Print", class: 'control-label' %>
                      <br/><small id="requestable__type_recap_caption_<%= requestable.item[:id] %>" class="form-text text-muted"><%= I18n.t('requests.recap.brief_msg') %></small>
                      <br/>
                  <% else %>
                      <%= show_service_options requestable %>
                      <%= hidden_service_options requestable %>
                  <% end %>
                  <% unless requestable.aeon? %>
                    <%= pickup_choices requestable, @request.default_pickups %>
                  <% end %>
                  <% if requestable.services.include?('recap_edd') %>
                      <br/>
                      <%= radio_button_tag "requestable[][delivery_mode_#{requestable.item[:id]}]", "edd", false, data: { target: "#fields-eed__#{requestable.item[:id]}" }, 'aria-expanded' => 'false', 'aria-controls' => "fields-eed__#{requestable.item[:id]}", class: 'control-label' %>
                      <%= label_tag "requestable__type_recap_edd_#{requestable.item[:id]}", "Electronic Delivery", class: 'control-label' %>
                      <br/><small id="requestable__type_recap_edd_caption_<%= requestable.item[:id] %>" class="form-text text-muted"><%= I18n.t('requests.recap_edd.brief_msg') %></small>

                      <%= render partial: "edd_fields", locals: { requestable: requestable } %>
                  <% end %>
                </td>
              </tr>
              <% if requestable.online? %>
                <%= render partial: "online_items", locals: { requestable: requestable } %>
              <% end %>
            <% end %>
            <% if fill_in_eligible? requestable_list %>
              <%= render partial: "fill_in_field", locals: { requestable: requestable_list.last, default_pickups: @request.default_pickups } %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
    <% unless @request.all_items_online? %>
      <%= f.submit submit_message(@request.requestable), class: "btn btn-primary submit--request", disabled: submit_button_disabled(@request.requestable), data: { disable_with: "Submitting Request" } %>
    <% end %>
  <% end %>
<% end %>
